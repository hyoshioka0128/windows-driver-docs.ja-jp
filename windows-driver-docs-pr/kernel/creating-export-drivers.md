---
title: エクスポート ドライバーの作成
description: エクスポート ドライバーの作成
ms.assetid: 60ce7d0d-0eab-4af6-890a-45ab206816aa
keywords:
- エクスポートドライバーの WDK カーネル
- エクスポートドライバーの読み込み (WDK カーネル)
- export driver 関数をインポートしています
- モジュール定義ファイルの WDK カーネル
- .def ファイル
- def ファイル
- カーネルモードドライバー WDK、エクスポートドライバー
ms.date: 10/14/2019
ms.localizationpriority: medium
ms.openlocfilehash: 78652fa0f3ccf232c4ecbd134a1ae4e741594d93
ms.sourcegitcommit: a59b63e84e6790af4c17b232f11a2f50f875c97a
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/03/2020
ms.locfileid: "87527846"
---
# <a name="creating-export-drivers"></a>エクスポート ドライバーの作成



エクスポートドライバーは、さまざまなハードウェア固有またはデバイススタック固有のコンポーネントによって読み込まれる可能性がありますが、完全なカーネルモードドライバーの特性の一部を備えていないカーネルモードの DLL です。

具体的には、エクスポートドライバーにはディスパッチテーブルがありません。ドライバースタックには場所がなく、システムサービスとして定義されているサービスコントロールマネージャーのデータベースにはエントリがありません。

エクスポートドライバーはディスパッチテーブルを持っていませんが、標準ドライバーにディスパッチルーチンを提供できます。 標準ドライバーは、ディスパッチルーチンを独自のディスパッチテーブルに挿入します。

エクスポートドライバーには、呼び出されないスタブ[**Driverentry**](https://docs.microsoft.com/windows-hardware/drivers/ddi/content/wdm/nc-wdm-driver_initialize)ルーチンがあります。

カーネルモードエクスポートドライバーは、基になるスタックやハードウェアの特性に依存しないドライバーペアの一部を実装する場合に特に適しています。

Windows には、いくつかのエクスポートドライバーが含まれています。 たとえば、SCSI ポートドライバー、テープクラスドライバー、IDE コントローラードライバーは、システムによって提供されるすべてのエクスポートドライバーで、他のドライバーによって読み込まれています。

標準ドライバーは、エクスポートドライバーとしても機能します。 ドライバーを両方の方法で機能させるには、ドライバーをエクスポートドライバーとして作成し、通常のドライバーとして読み込む必要があります。

### <a name="building-an-export-driver"></a>エクスポートドライバーの構築

Visual Studio でエクスポートドライバーを作成するには、次の手順に従います。

1. **空の WDM ドライバー**など、テンプレートから新しいプロジェクトを作成します。
2. [プロジェクトの設定] で、 **[全般 > 構成の種類**] を [**ダイナミックライブラリ (.dll)**] に設定します。
3. [**リンカー-> 詳細設定]-[> エントリポイントなし** **] (/NOENTRY)** に設定します。
4. モジュール定義ファイルをプロジェクトに追加します。次に例を示します。
  ```
  LIBRARY mydriver
  EXPORTS
    DllInitialize PRIVATE
    DllUnload PRIVATE
  ```

カーネルモードの DLL のエントリポイントは常に**DllInitialize**です。 DLL が読み込まれた直後に、システムはカーネルモードの DLL の DllInitialize ルーチンを呼び出します。 エクスポートドライバーは、 **DllInitialize**ルーチンを提供する必要があります。 **DllInitialize**ルーチンを使用して、DLL 内の他のルーチンが必要とするリソースを取得または初期化できます。 

**Dllentry**マクロを使用してエントリポイントを指定することはできません。 

```cpp
NTSTATUS DllInitialize(
  _In_ PUNICODE_STRING RegistryPath
);
```
RegistryPath は、カウントされた Unicode 文字列へのポインターで、DLL のレジストリキーへのパスを指定します。 **\currentcontrolset\services\dllname は HKEY_LOCAL_MACHINE**ます。 DLL ルーチンは、このキーを使用して DLL 固有の情報を格納できます。 RegistryPath が指すバッファーは、 **DllInitialize**が終了すると解放されます。 そのため、DLL でキーを使用する場合、 **DllInitialize**はキー名を複製する必要があります。 


ビルドプロセスでは、拡張子が .lib のエクスポートライブラリと、拡張子が .sys のエクスポートドライバーが生成されます。

### <a name="importing-functions-from-an-export-driver"></a>エクスポートドライバーからの関数のインポート

エクスポートドライバーによってエクスポートされる関数をインポートするには、DECLSPEC import マクロを使用して関数を宣言する必要があります。このマクロは、 \_ Ntdef. h で定義されています。 次に例を示します。

```cpp
DECLSPEC_IMPORT int LoadPrinterDriver (int arg1); 
```

このマクロは、必要な場合は、これらのプラットフォームの** \_ \_ declspec**(dllimport) ストレージクラス宣言に解決されます。

エクスポートドライバーでは、エクスポートする関数を DECLSPEC export マクロを使用して宣言する必要があり \_ ます。 このマクロは、必要な場合は、これらのプラットフォームの** \_ \_ declspec**(dllexport) ストレージクラス宣言に解決されます。これらのプラットフォームでは、不要な場合は、これらのプラットフォームに対しては実行されません。 エクスポートドライバーによって標準ドライバーにディスパッチルーチンが提供される場合、そのルーチンをエクスポートする必要はありません。

### <a name="loading-and-unloading-an-export-driver"></a>エクスポートドライバーの読み込みとアンロード

エクスポートドライバーは% Windir% System32 drivers ディレクトリにインストールする必要があり \\ \\ ます。 Windows 2000 以降では、オペレーティングシステムは、エクスポートドライバーの機能が他のドライバーによってインポートされた回数を示す参照カウントを保持します。 システムは、インポートするドライバーのいずれかがアンロードされるたびに、このカウントをデクリメントします。 参照カウントがゼロになると、エクスポートドライバーがアンロードされます。 ただし、エクスポートドライバーには、標準のエントリポイントとアンロードルーチン、 **DllInitialize**および**dllunload**が含まれている必要があります。また、オペレーティングシステムはこの参照カウントメカニズムをアクティブ化しません。

DLL のアンロード時に、システムはカーネルモード DLL の DllUnload ルーチンを呼び出します。

```cpp
NTSTATUS DllUnload(void);
```
エクスポートドライバーは、DllUnload ルーチンを提供する必要があります。 DLL 内のルーチンで使用されるすべてのリソースを解放するには、DllUnload ルーチンを使用します。 








