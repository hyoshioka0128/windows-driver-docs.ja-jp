---
title: Nt および Zw バージョンのネイティブ システム サービス ルーチンの使用
description: Nt および Zw バージョンのネイティブ システム サービス ルーチンの使用
ms.assetid: 89627ddb-621d-4d27-acd6-16308689165d
keywords:
- ネイティブシステムサービス API WDK
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 62d016af977e91d72ac75e868b6b4a416517f278
ms.sourcegitcommit: 63c4fc1b6eae1cb44bae84e5f5e518abb172fc34
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2020
ms.locfileid: "86160237"
---
# <a name="using-nt-and-zw-versions-of-the-native-system-services-routines"></a>Nt および Zw バージョンのネイティブ システム サービス ルーチンの使用


Windows ネイティブオペレーティングシステムサービス API は、カーネルモードで実行されるルーチンのセットとして実装されます。 これらのルーチンには、プレフィックス**Nt**または**Zw**で始まる名前が付いています。 カーネルモードドライバーは、これらのルーチンを直接呼び出すことができます。 ユーザーモードのアプリケーションは、システムコールを使用してこれらのルーチンにアクセスできます。

いくつかの例外を除き、それぞれのネイティブシステムサービスルーチンには、名前が似ていてプレフィックスが異なる2つの異なるバージョンがあります。 たとえば、 [Ntcreatefile](https://go.microsoft.com/fwlink/p/?linkid=157250)と[**zwcreatefile**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatefile)を呼び出すと、同様の操作が実行され、実際には同じカーネルモードシステムルーチンによって処理されます。 ユーザーモードからのシステムコールの場合、 **Nt**および**Zw**バージョンのルーチンは同じように動作します。 カーネルモードドライバーからの呼び出しの場合、ルーチンの**Nt**および**Zw**バージョンは、呼び出し元がルーチンに渡すパラメーター値を処理する方法が異なります。

カーネルモードドライバーは、ネイティブシステムサービスルーチンの**Zw**バージョンを呼び出して、パラメーターが信頼されたカーネルモードのソースからのものであることをルーチンに通知します。 この場合、このルーチンでは、最初にパラメーターを検証せずに、パラメーターを安全に使用できると想定しています。 ただし、パラメーターがユーザーモードのソースまたはカーネルモードのソースからのものである場合、代わりに、ドライバーは、呼び出し元のスレッドの履歴に基づいて、パラメーターがユーザーモードとカーネルモードのどちらで発生したかを判断する**Nt**バージョンのルーチンを呼び出します。 ルーチンがユーザーモードパラメーターとカーネルモードパラメーターを区別する方法の詳細については、「前の[**モード**](previousmode.md)」を参照してください。

ユーザーモードアプリケーションがネイティブシステムサービスルーチンの**Nt**または**Zw**バージョンを呼び出すと、そのルーチンは、受け取ったパラメーターを、信頼されていないユーザーモードのソースから取得した値として常に扱います。 ルーチンは、パラメーターを使用する前にパラメーター値を徹底的に検証します。 特に、ルーチンは、呼び出し元が指定したバッファーをプローブして、バッファーが有効なユーザーモードメモリに配置され、適切にアラインされていることを確認します。

ネイティブシステムサービスルーチンは、受け取るパラメーターについて、追加の想定を行います。 ルーチンが、カーネルモードドライバーによって割り当てられたバッファーへのポインターを受け取る場合、このルーチンは、バッファーがユーザーモードメモリではなくシステムメモリに割り当てられたものと想定しています。 ルーチンがユーザーモードアプリケーションによって開かれたハンドルを受け取ると、ルーチンはカーネルモードハンドルテーブルではなく、ユーザーモードハンドルテーブルでハンドルを検索します。

いくつかのインスタンスでは、ユーザーモードとカーネルモードからの呼び出しの間で、パラメーター値の意味がより大きく異なります。 たとえば、 [**Zwnotifychangekey**](https://msdn.microsoft.com/library/windows/hardware/ff566488)ルーチン (またはその**ntnotifychangekey**に対応する) には、パラメーターがユーザーモードとカーネルモードのどちらのソースであるかによって異なることを意味する、 *Apcroutine*と*apcroutine*という2つの入力パラメーターがあります。 ユーザーモードからの呼び出しの場合、 *Apcroutine*は apc ルーチンをポイントし、 *APCROUTINE*は、apc ルーチンを呼び出すときにオペレーティングシステムによって提供されるコンテキスト値をポイントします。 カーネルモードからの呼び出しの場合、 *Apcroutine*は[**ワーク \_ キュー \_ 項目**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_work_queue_item)構造をポイントし、 *apcroutine*は、**作業 \_ キュー \_ 項目**構造によって記述される作業キュー項目の種類を指定します。

ここでは、次のトピックについて説明します。

[**PreviousMode**](previousmode.md)

[ライブラリとヘッダー](libraries-and-headers.md)

[Zw プレフィックスの意味](what-does-the-zw-prefix-mean-.md)

[アクセス権の指定](access-mask.md)

[NtXxx ルーチン](ntxxx-routines.md)

 

 




