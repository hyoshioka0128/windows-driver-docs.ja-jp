---
title: セマフォ オブジェクト
description: セマフォ オブジェクト
ms.assetid: e6703c39-3b47-4d3b-86e7-bf2bf37af493
keywords:
- カーネルディスパッチャーオブジェクト WDK、セマフォオブジェクト
- ディスパッチャーオブジェクト WDK カーネル、セマフォオブジェクト
- セマフォオブジェクト WDK カーネル
- KeInitializeSemaphore
- 待機 (セマフォオブジェクトを)
- KeReleaseSemaphore
- カウントセマフォ WDK カーネル
- バイナリセマフォ WDK カーネル
- 待機状態 WDK カーネル
ms.date: 06/16/2017
ms.localizationpriority: medium
ms.openlocfilehash: 101339931cd66ef8fa5915e241546fc912cb9b1c
ms.sourcegitcommit: f68ab92a8f1c13502e070297cf5410f6bbe4a9dc
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/10/2020
ms.locfileid: "86213177"
---
# <a name="semaphore-objects"></a>セマフォ オブジェクト





すべてのドライバーは、セマフォオブジェクトを使用して、ドライバーによって作成されたスレッドとその他のドライバールーチンの間で操作を同期できます。 たとえば、ドライバー専用のスレッドは、ドライバーに未処理の i/o 要求がない場合に待機状態になることがあります。また、ドライバーのディスパッチルーチンは、IRP をキューに入れた直後に、セマフォをシグナル状態に設定することがあります。

I/o 操作を要求するスレッドのコンテキストで実行される最上位レベルのドライバーのディスパッチルーチンは、セマフォを使用して、ディスパッチルーチン間で共有されるリソースを保護することがあります。 同期 i/o 操作の下位レベルのドライバーディスパッチルーチンでは、セマフォを使用して、ディスパッチルーチンのサブセット間で共有されているリソースや、ドライバーによって作成されたスレッドを保護することもできます。

セマフォオブジェクトを使用するドライバーは、セマフォを待機または解放する前に[**Keinitializesemaphore**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-keinitializesemaphore)を呼び出す必要があります。 次の図は、スレッドがあるドライバーでセマフォオブジェクトを使用する方法を示しています。

![セマフォオブジェクトを待機していることを示す図](images/3semobj.png)

上の図に示すように、このようなドライバーでは、セマフォオブジェクトの記憶域を提供する必要があります。このオブジェクトは常駐している必要があります。 ドライバーによって作成されたデバイスオブジェクトの[デバイス拡張機能](device-extensions.md)、コントローラー[オブジェクト](using-controller-objects.md)を使用している場合はコントローラー拡張機能、ドライバーによって割り当てられた非ページプールを使用できます。

ドライバーの[*AddDevice*](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_add_device)ルーチンが**keinitializesemaphore**を呼び出す場合は、セマフォオブジェクトのドライバーの常駐ストレージへのポインターを渡す必要があります。 さらに、呼び出し元は、前の図に示すように、初期状態を決定するセマフォオブジェクトの*カウント*を指定する必要があります (シグナルの場合は0以外)。

また、呼び出し元は、次のいずれかのように、セマフォの*制限*を指定する必要があります。

-   **制限 = 1**

    このセマフォがシグナル状態に設定されている場合、セマフォがシグナル状態に設定されるのを待機している1つのスレッドが実行の対象になり、セマフォによって保護されている任意のリソースにアクセスできます。

    この種類のセマフォは、スレッドがセマフォで保護されたリソースに排他的にアクセスしているか、スレッドによって保護されたリソースに排他的にアクセスできないため、*バイナリセマフォ*とも呼ばれます。

-   **制限 &gt; 1**

    このセマフォがシグナル状態に設定されている場合、セマフォオブジェクトがシグナル状態に設定されるのを待機しているスレッドの数は、実行の対象になり、セマフォによって保護されている任意のリソースにアクセスできるようになります。

    この種類のセマフォは、セマフォをシグナル状態に設定するルーチンも、待機中のスレッドの状態を待機中から準備完了に変更できる待機中のスレッドの数を指定するため、*カウントセマフォ*と呼ばれます。 このような待機中のスレッドの数には、セマフォが初期化されたときに設定された*制限*、またはこの事前設定された*制限*より少ない数の値を指定できます。

デバイスまたは中間のドライバーの中に、ドライバーで作成されたスレッドが1つしかないものがあります。さらに、セマフォが取得または解放されるのを待機するスレッドのセットも少なくなります。 システム提供のドライバーの中には、セマフォオブジェクトを使用するものと、バイナリセマフォを使用するものがあります。 バイナリセマフォは[mutex オブジェクト](mutex-objects.md)と機能が似ているように見えるかもしれませんが、バイナリセマフォでは、SMP マシンで実行されているシステムスレッド用の mutex オブジェクトのデッドロックに対する組み込みの保護が提供されていません。

初期化されたセマフォを含むドライバーが読み込まれると、共有リソースを保護するセマフォでの操作を同期できます。 たとえば、システムフロッピーコントローラードライバーなどの Irp のキューを管理するデバイス専用のスレッドを使用するドライバーは、前の図に示すように、セマフォで IRP キューを同期させることができます。

1.  スレッドは、初期化されたセマフォオブジェクトのドライバー提供のストレージへのポインターを使用して[**KeWaitForSingleObject**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitforsingleobject)を呼び出し、それ自体を待機状態にします。

2.  デバイス i/o 操作を必要とする Irp が開始されます。 ドライバーのディスパッチルーチンは、このような各 IRP をスピンロックコントロールの下のインタロックされたキューに挿入し priority boost、 [**KeReleaseSemaphore**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kereleasesemaphore)を呼び出し**ます。** これは、セマフォオブジェクトへのポインターを使用して *、(前*の図で示したように) スレッドのカウントに追加される1の*調整*で、各 Irp がキューに入れられ *、ブール値*の 0以外のセマフォ数は、セマフォオブジェクトをシグナル状態に設定し、待機中のスレッドの状態を ready に変更します。

3.  カーネルは、プロセッサが使用可能になるとすぐにスレッドをディスパッチします。つまり、優先度の高い他のスレッドは現在準備完了状態であり、カーネルモードルーチンが上位の IRQL で実行されることはありません。

    スレッドは、スピンロック制御下のインタロックされたキューから IRP を削除し、さらに処理するために他のドライバールーチンに渡し、もう一度[**KeWaitForSingleObject**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kewaitforsingleobject)を呼び出します。 セマフォがまだシグナル状態に設定されている場合 (つまり、ドライバーのインタロックされたキューにある Irp が多くなることを示す0以外の場合)、カーネルは再びスレッドの状態を [待機中] から [準備完了] に変更します。

    このようにカウントセマフォを使用することにより、このようなドライバースレッドは、スレッドが実行されるたびに、インタロックされたキューから IRP が削除されることを認識します。

*Wait*パラメーターを**TRUE**に設定して[**KeReleaseSemaphore**](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kereleasesemaphore)を呼び出すと、呼び出し元が**KeReleaseSemaphore**から戻るときに**kewait*Xxx*オブジェクト**のサポートルーチンをすぐに呼び出すことを示します。

*Wait*パラメーターを KeReleaseSemaphore に設定する場合は、次のガイドラインを考慮してください。

IRQL パッシブレベルで実行されるページング可能なスレッドまたはページング可能なドライバールーチンは、 \_ *Wait*パラメーターを**TRUE**に設定して**KeReleaseSemaphore**を呼び出すことはできません。 このような呼び出しでは、 **KeReleaseSemaphore**と**kewait*Xxx*オブジェクト**の呼び出しの間に呼び出し元がページアウトされた場合に、致命的なページフォールトが発生します。

パッシブレベルよりも大きい IRQL で実行される標準のドライバールーチンで \_ は、システムを停止することなく、任意のディスパッチャーオブジェクトで0以外の間隔を待機することはできません。詳細については、「[カーネルディスパッチャーオブジェクト](kernel-dispatcher-objects.md)」を参照してください。 ただし、このようなルーチンは、ディスパッチレベル以下の IRQL で実行中に**KeReleaseSemaphore**を呼び出すことができ \_ ます。

標準のドライバールーチンを実行する IRQLs の概要については、「[ハードウェアの優先順位の管理](managing-hardware-priorities.md)」を参照してください。 特定のサポートルーチンの IRQL 要件については、ルーチンのリファレンスページを参照してください。

 

 




