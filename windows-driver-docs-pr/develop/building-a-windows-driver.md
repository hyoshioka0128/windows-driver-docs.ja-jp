---
title: Windows ドライバーの構築
description: Windows ドライバーの構築に関するガイド
ms.date: 04/28/2020
ms.localizationpriority: medium
ms.openlocfilehash: 1ad7d8891465c5801bdcc0e4c008d7ddc7cc04c8
ms.sourcegitcommit: 958a5ced83856df22627c06eb42c9524dd547906
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/12/2020
ms.locfileid: "83270477"
---
# <a name="building-a-windows-driver"></a>Windows ドライバーの構築

Microsoft Visual Studio 2019 を [Windows Driver Kit (WDK) バージョン 2004](https://docs.microsoft.com/windows-hardware/drivers/download-the-wdk) と共に使用し、Windows ドライバーを構築できます。 キットとツールは、[Windows ハードウェア デベロッパー センター](https://go.microsoft.com/fwlink/p/?LinkId=524487)からダウンロードできます。

多くの場合、レガシ カーネルモード ドライバーは、そのドライバーでユーザーモード コンポーネントを使っていない限り、Windows ドライバーとして再コンパイルできます。 レガシ WDM ドライバーと KMDF ドライバーは、Windows 10 をターゲットとする Windows ドライバーとして再コンパイルでき、変換の必要はありません。  これらのドライバーは変換せずにコンパイルできますが、ドライバーが Windows ドライバーの要件をすべて満たしているとは限りません。  Windows ドライバーの要件に関する詳細については、「[Windows ドライバーの概要](getting-started-with-windows-drivers.md)」を参照してください。  

これに対し、既存のユーザーモード ドライバーを Windows ドライバーとしてコンパイルするには、変更が必要になることがあります。 つまり、ドライバー パッケージには UWP の外部の依存関係が存在しないようにする必要があります。 たとえば、Win32 API は、一部のみが UWP の内部に存在します。

## <a name="converting-an-existing-driver-project-to-a-windows-driver-project"></a>既存のドライバー プロジェクトの Windows ドライバー プロジェクトへの変換

1.  Visual Studio 2019 で、既存のドライバー プロジェクトを開きます。
2.  [ソリューション エクスプローラー] ウィンドウで、ソリューションを右クリックし、 **[構成マネージャー]** をクリックします。 ターゲット オペレーティング システムを Windows 10 に設定します。
3.  ドライバー プロジェクトを右クリックし、 **[プロパティ]** をクリックします。 **[構成プロパティ] の [ドライバー]** で、 **[ターゲット プラットフォーム]** が **[Windows ドライバー]** に設定されていることを確認します。 Windows 10 デスクトップ エディションで実行されるドライバーをビルドするには、 **[デスクトップ]** を選択します。
4.  ドライバーをビルドします。 リンカーのエラーが発生する場合があります。
5.  エラー ログを調べてエラーを 1 つずつ修正します。 可能な代替 API については、マニュアルの個別のリファレンス ページを参照してください。 代替 API を使用できない場合は、ドライバーの設計を変更することが必要になる場合があります。

## <a name="creating-a-new-windows-driver-project-in-microsoft-visual-studio"></a>Microsoft Visual Studio での新しい Windows ドライバー プロジェクトの作成

1.  テンプレートから新しいドライバーを作成します ( **[ファイル]、[新しいプロジェクト]、[新しいプロジェクトの作成]、[プロジェクトの種類]、[ドライバー]、目的のテンプレートの順に選択します**)。
2.  プロジェクトの作成後、[ソリューション エクスプローラー] ウィンドウでソリューションを右クリックし、 **[構成マネージャー]** をクリックします。 **[アクティブ ソリューション構成]** を目的のターゲット Windows バージョンに設定し、 **[アクティブ ソリューション プラットフォーム]** を **[Win32]** または **[x64]** に設定します。 一覧に **[ARM]** が表示されない場合に ARM 用にビルドするには、 **[&lt;新規作成...&gt;]** を選択します。

    Windows 10 を選ぶと、ドライバー モデルの既定値は **[ユニバーサル]** になります。

    手動でドライバー モデルを変更するには、ドライバー プロジェクトを右クリックし、[プロパティ] をクリックします。 **[構成プロパティ] -> [ドライバーの設定] -> [全般]** の順にクリックし、 **[ターゲット プラットフォーム]** のエントリを検索します。 **[Windows ドライバー]** を選択します。 Microsoft Visual Studio はこの設定を使って、リンクするライブラリを決定します。

    **注**  Windows 10 バージョン 1809 より前の Windows バージョン用の Windows ドライバーをビルドすることはできません。
3.  必要に応じて .inf ファイルを変更して、INF ファイルの [**Strings**](https://docs.microsoft.com/windows-hardware/drivers/install/inf-strings-section) セクションにプロバイダーを指定します。%*ManufacturerName*% トークンとして指定されたプロバイダーは、後でこのセクションの定義に従って展開されます。 たとえば、次のように入力します。

    ```cpp
    Provider="Contoso"
    ```

4.  これで、ソリューションをビルドできるようになりました。 Visual Studio は、必要なライブラリに対してリンクし、.cat ファイル、.inf ファイル、およびドライバーのバイナリを生成します。

## <a name="creating-a-new-universal-application-or-dll-project-in-microsoft-visual-studio"></a>Microsoft Visual Studio での新しいユニバーサル アプリケーションまたは DLL プロジェクトの作成

1.  テンプレートから新しいドライバーを作成し ( **[ファイル]、[新しいプロジェクト]、[新しいプロジェクトの作成]、[プロジェクトの種類]、[ドライバー]、目的のテンプレートの順に選択**)、 **[Empty Desktop Application for Drivers (Universal)]\(ドライバー用の空のデスクトップ アプリケーション (ユニバーサル)\)** または **[Empty Dll for Drivers (Universal)]\(ドライバー用の空の DLL (ユニバーサル)\)** を選択します。
2.  プロジェクトの作成後、[ソリューション エクスプローラー] ウィンドウでソリューションを右クリックし、 **[構成マネージャー]** をクリックします。 **[アクティブ ソリューション構成]** を目的のターゲット Windows バージョンに設定し、 **[アクティブ ソリューション プラットフォーム]** を **[Win32]** または **[x64]** に設定します。 一覧に ARM が表示されない場合に ARM 用にビルドするには、 **[<新規作成...>]** を選択します。
Windows 10 を選ぶと、アプリケーション モデルの既定値は **[ユニバーサル]** になります。
ターゲット プラットフォームを手動で変更するには、ドライバー プロジェクトを右クリックして [プロパティ] を選択します。 **[構成プロパティ] -> [ドライバーの設定] -> [全般]** の順にクリックし、 **[ターゲット プラットフォーム]** のエントリを検索します。
3.  ソリューションをビルドします。

ドライバーのビルド時に Visual Studio で使える構成設定については、「[WDK を使ったドライバーのビルド](building-a-driver.md)」をご覧ください。
