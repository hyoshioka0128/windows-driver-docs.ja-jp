---
title: Windows コンテナー用のウイルス対策最適化
description: このトピックでは、Windows コンテナー内で実行するときにウイルス対策製品が利用できる最適化について説明します。
ms.assetid: 101BC08B-EE63-4468-8B12-C8C8B0E99FC5
ms.date: 03/06/2020
ms.localizationpriority: medium
ms.openlocfilehash: cb32050e0171207446f461cdbf31d24d1c0d8092
ms.sourcegitcommit: 5e5f3491e29f99b11a12b45da870043e0e92ddc5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/22/2020
ms.locfileid: "86949032"
---
# <a name="anti-virus-optimization-for-windows-containers"></a>Windows コンテナー用のウイルス対策最適化

**このページの情報は、次のものに適用されます。**
- Windows 10 バージョン1607以降
- Windows Server 2016 以降のバージョン
- ホストで実行されているウイルス対策 (AV) 製品

このトピックでは、Windows コンテナーファイルの冗長スキャンを回避し、コンテナーの起動時間を向上させるために AV 製品が使用できる最適化について説明します。

## <a name="container-overview"></a>コンテナーの概要

Windows コンテナー機能は、アプリケーションの配布と展開を簡略化するように設計されています。 詳細については、「 [Windows コンテナー](https://docs.microsoft.com/virtualization/windowscontainers/about/about_overview)の概要」を参照してください。

コンテナーは、任意の数のパッケージレイヤーから構築されます。 Windows ベース OS パッケージは、最初のレイヤーを形成します。

各コンテナーには、そのコンテナーのシステムボリュームを表す分離ボリュームがあります。 コンテナー分離フィルター (*wcifs.sys*) は、このコンテナーボリュームにパッケージレイヤーの仮想オーバーレイを提供します。 オーバーレイは、プレースホルダー (再解析ポイント) を使用して実現されます。 コンテナーが最初に overlain パスにアクセスする前に、プレースホルダーを使用してボリュームがシード処理されます。 プレースホルダーファイルの読み取りは、バッキングパッケージファイルに送られます。 このようにして、複数のコンテナーボリュームが同じ基になるパッケージファイルデータストリームにアクセスできます。

コンテナーによってファイルが変更された場合、分離フィルターでは、書き込み時のコピーが実行され、プレースホルダーがパッケージファイルの内容に置き換えられます。 これにより、特定のコンテナーのパッケージファイルへの "リンケージ" が中断されます。

## <a name="read-redirection"></a>リダイレクトの読み取り

プレースホルダーファイルからの読み取りは、分離フィルターによって適切なパッケージレイヤーにリダイレクトされます。 リダイレクトは、フィルターのレベルで実行されます。 フィルターは AV 範囲を下回るため、AV フィルターでは読み取りリダイレクトが表示されません。 また、リダイレクトを設定するために実行されたパッケージファイルが開きません。

AV フィルターには、コンテナーシステムボリューム上のすべての操作が完全に表示されます。 プレースホルダーファイルに加えて、ファイルの変更や新しいファイルの追加に関する操作も表示されます。

## <a name="redundant-scanning-problem"></a>冗長スキャンの問題

多くの場合、同じパッケージレイヤーに応じて多数のコンテナーが存在します。 指定されたパッケージファイルの同じデータストリームによって、複数のコンテナーシステムボリューム上のプレースホルダーのデータが提供されます。 その結果、すべてのコンテナーの同じデータに対して、重複する AV スキャンが発生する可能性があります。 これにより、コンテナーのパフォーマンスに不要な悪影響が生じます。 これは、コンテナーがすぐに開始されることが予想され、有効期間が短くなる可能性があるため、signification コストです。

## <a name="recommended-approach"></a>推奨されるアプローチ

コンテナーでの冗長なスキャンを回避するには、以下で説明するように、AV 製品で動作を変更することをお勧めします。 このアプローチでは、お客様に対するリスク/報酬特典を決定するために、AV 製品が必要です。 詳細については、このページの下部にある「**利点とリスク**」を参照してください。

### <a name="1-package-install"></a>1. パッケージのインストール

パッケージのインストール中に、管理ツールによってパッケージ内のファイルがレイヤールートに配置されます。 AV フィルタは、パッケージルートに配置されている間はファイルのスキャンを続行し、通常はファイルをスキャンします。 これにより、レイヤー内のすべてのファイルがマルウェアに対して最初にクリーンであることが保証されます。

### <a name="2-container-start-and-execution"></a>2. コンテナーの開始と実行

コンテナーボリュームをリアルタイムでスキャンするには、重複を回避する方法で AVs をスキャンする必要があります。 プレースホルダーファイルには特別な考慮が必要です。 コンテナーによって変更されたファイルまたはコンテナー内に作成された新しいファイルはリダイレクトされないため、冗長スキャンが問題になることはありません。

重複するスキャンを回避するには、まず、そのボリュームのコンテナーボリュームとプレースホルダーを、AV フィルターで識別する必要があります。 さまざまな理由により、ボリュームがコンテナーボリュームであるか、または特定のファイルがプレースホルダーファイルであるかどうかをクエリするための直接の方法はありません。 分離フィルターでは、アプリケーションの互換性のためにプレースホルダーの再解析ポイントが非表示になります (再解析ポイントにアクセスしていることが認識されている場合、一部のアプリケーションは正しく動作しません)。 また、コンテナーが実行されている間、ボリュームはコンテナーボリュームにすぎません。 コンテナーが停止し、ボリュームが再マウントされる可能性があります。 代わりに、作成前に、AV フィルターは、ファイルオブジェクトに対してクエリを実行して、コンテナーのコンテキストで開かれているかどうかを判断する必要があります。 次に、作成完了時に、作成して、プレースホルダー状態を受信します。

AV 製品では、次の変更が必要です。

- **コンテナーボリュームでの事前作成時に、プレースホルダー情報を受信する [作成] の [送信] データに ECP をアタッチします。** これらの作成は、 **IoGetSiloParameters**を使用して、FILEOBJECT からサイロパラメーターを照会することによって識別できます。 注フィルターでは**WCIFS_REDIRECTION_ECP_CONTEXT**構造のサイズを指定する必要があります。 他のすべてのフィールドは、ECP が確認された場合に、out フィールドに設定されます。

- **[作成後] で、ECP が確認された場合は、ECP リダイレクトフラグを確認します。** フラグは、開いているがパッケージレイヤーまたはスクラッチルート (新規または変更されたファイル) からサービスを処理したかどうかを示します。 フラグは、パッケージレイヤーが登録されているかどうか、およびリモートであるかどうかも示します。

  - *リモートレイヤーからサービスが提供されている場合*、AV はファイルのスキャンをスキップします。 これは、リダイレクトフラグによって示されます。`WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_LAYER && WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_REMOTE_LAYER`

    リモート層は、リモートホストでスキャンされていると見なすことができます。 Hyper-v コンテナーパッケージは、コンテナーをホストするユーティリティ VM に対してリモートです。 これらのパッケージは、ユーティリティ VM から SMB ループバックを介してアクセスされたときに、Hyper-v ホスト上で正常にスキャンされます。

    VolumeGUID と FileId はリモートでは適用されないため、これらのフィールドは設定されません。

  - *登録されたレイヤーからサービスが提供される場合*、AV はファイルのスキャンをスキップします。 これは、リダイレクトフラグによって示されます。`WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_LAYER &&  WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_REGISTERED_LAYER`

    登録されたレイヤーは、パッケージのインストール中および署名の更新後に、非同期的にスキャンする必要があります。

    >[!NOTE]
    > 登録済みのレイヤーは、将来システムによって識別されない場合があります。 この場合、ローカルレイヤーファイルは、最後の箇条書きで説明されているように、個別に識別する必要があります。

  - *ローカルパッケージレイヤーからサービスが提供されるオープンの*場合、AV では、レイヤーファイルの指定された volumeguid と FileId を使用して、ファイルをスキャンする必要があるかどうかを判断する必要があります。 これには、ボリューム GUID と FileId によってインデックス付けされたスキャン済みファイルのキャッシュを作成するために、AV が必要になる可能性があります。 これはリダイレクトフラグによって示されます。`WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_LAYER`

  - *新規または変更*されたファイルがスクラッチの場所にある場合、AV 製品はファイルをスキャンし、通常の修復を実行します。 これはリダイレクトフラグによって示されます。`WCIFS_REDIRECTION_FLAGS_CREATE_SERVICED_FROM_SCRATCH`

    この場合、レイヤーファイルは存在しないため、VolumeGUID と FileId は設定されません。

  - "このファイルはレイヤーからサービスされています" という名前のストリームコンテキストで永続的なマーカーとして保存しないでください。 最初にレイヤールートから処理されるファイルは、作成後に変更される可能性があります。 この場合、同じファイルの後続の作成では、作成がコンテナーボリュームからサービスされていることを示している可能性があります。 この問題が発生する可能性があることを、AV フィルタが理解している必要があります。

## <a name="dont-use-the-layerrootlocations-registry-key"></a>レイヤー Root場所レジストリキーは使用しないでください

以前は、レジストリキーを使用して `LayerRootLocations` 基本イメージの場所を取得することをお勧めします。 AV 製品では、このレジストリキーを使用できなくなります。 代わりに、このトピックで推奨されている方法を使用して、重複スキャンを回避してください。

パッケージレイヤーの登録に使用されたレジストリの場所:

`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization\LayerRootLocations`

## <a name="benefits-and-risks"></a>利点とリスク

これらの新しい最適化を AV 製品に使用する場合は、次の利点とリスクについて検討してください。

### <a name="benefits"></a>メリット

- コンテナーの開始または実行時間には影響しません (最初のコンテナーであっても)。
- 複数のコンテナー内の同じコンテンツのスキャンを回避します。
- Windows Server コンテナーに対して機能します。 Hyper-v コンテナーの場合、これはパッケージに対して機能しますが、コンテナーを実行するには追加の作業が必要です。

### <a name="risks"></a>リスク

署名の更新と次にスケジュールされている予防的なマルウェア対策スキャンの間にコンテナーが起動した場合、コンテナーで実行されたファイルは、最新のマルウェア対策の署名に関してスキャンされません。 このリスクを軽減するために、最後のプロアクティブスキャン以降の署名の更新がない場合にのみ、AV 製品でリダイレクトされたファイルのスキャンをスキップできます。 これにより、最新の署名でプロアクティブスキャンが完了するまで、コンテナーのパフォーマンスの低下が制限されます。 必要に応じて、AV 製品はこの状況でプロアクティブスキャンをトリガーできます。これにより、以降のコンテナーの起動が効率的になります。
