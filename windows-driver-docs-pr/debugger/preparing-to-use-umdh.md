---
title: UMDH の使用の準備
description: UMDH の使用の準備
ms.assetid: 9adebe43-3167-4e1a-ac98-db19ace944be
keywords:
- UMDH, UMDH の使用の準備
- UMDH、BSTR キャッシュの無効化
- SetNoOaCache 関数
- OANOCACHE 環境変数
- スタックトレースデータベース
ms.date: 05/23/2017
ms.localizationpriority: medium
ms.openlocfilehash: 4fb3c3bcfeeea51bee9a7d5de5c1dc5228e20bcb
ms.sourcegitcommit: dadc9ced1670d667e31eb0cb58d6a622f0f09c46
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/09/2020
ms.locfileid: "84534773"
---
# <a name="preparing-to-use-umdh"></a>UMDH の使用の準備

ユーザーモードダンプヒープ (UMDH) を使用してプロセスのヒープ割り当てをキャプチャする前に、このセクションで説明されている構成タスクを完了する必要があります。 コンピューターが正しく構成されていない場合、UMDH は結果を生成しません。または、結果が不完全または不正確になります。

### <a name="create-the-user-mode-stack-trace-database"></a>ユーザーモードのスタックトレースデータベースを作成する

UMDH を使用してプロセスのヒープ割り当てをキャプチャする前に、スタックトレースをキャプチャするように Windows を構成する必要があります。

プロセスに対してスタックトレースのキャプチャを有効にするには、 [GFlags](gflags.md)を使用して、プロセスの**Create user mode stack トレースデータベース**フラグを設定します。 これは、次のいずれかの方法で実行できます。

-   GFlags グラフィカルインターフェイスで、[**イメージファイル**] タブを選択します。ファイル名拡張子を含むプロセス名を入力します (たとえば notepad.exe)。 **Tab**キーを押して、[**ユーザーモードスタックトレースデータベースの作成**] を選択し、[**適用**] をクリックします。

-   また、同様に、次の GFlags コマンドラインを使用します。ここで、 *ImageName*はプロセス名 (ファイル名拡張子を含む) です。

    **gflags/I** *ImageName* **+ ust**

既定では、Windows が収集するスタックトレースデータの量は、x86 プロセッサでは 32 MB、x64 プロセッサでは 64 MB に制限されています。 このデータベースのサイズを大きくする必要がある場合は、GFlags グラフィカルインターフェイスの [**イメージファイル**] タブを選択し、プロセス名を入力して、tab キーを押し、[**スタックバックトレース (mb)** **]** チェックボックスをオンにして、関連付けられているテキストボックスに値 (MB) を入力し、[**適用**] をクリックします。

**メモ**   Windows リソースが制限される可能性があるため、必要な場合にのみこのデータベースを増やしてください。 より大きなサイズが不要になった場合は、この設定を元の値に戻します。

これらの設定は、プログラムのすべての新しいインスタンスに影響します。 プログラムの現在実行中のインスタンスには影響しません。

### <a name="access-the-necessary-symbols"></a>必要なシンボルにアクセスする

UMDH を使用する前に、アプリケーションの適切なシンボルにアクセスできる必要があります。 UMDH は、環境変数 NT シンボルパスで指定されたシンボルパスを使用し \_ \_ \_ ます。 この変数を、アプリケーションのシンボルを含むパスと同じに設定します。

Windows シンボルへのパスも指定すると、分析がより完全に完了する場合があります。 このシンボルパスの構文は、デバッガーで使用されるものと同じです。詳細については、「[シンボルパス](symbol-path.md)」を参照してください。

たとえば、アプリケーションのシンボルが C: MyApp シンボルにあり、 \\ \\ Windows シンボルファイルが myshare winsymbols にインストールされている場合、 \\ \\ \\ 次のコマンドを使用してシンボルパスを設定します。

```console
set _NT_SYMBOL_PATH=c:\myapp\symbols;\\myshare\winsymbols
```

別の例として、アプリケーションのシンボルが C: MyApp シンボルにあり、 \\ \\ Windows シンボルに対してパブリックな Microsoft シンボルストアを使用する場合、 \\ ダウンストリームストアとして c: mycache を使用します。次のコマンドを使用してシンボルパスを設定します。

```console
set _NT_SYMBOL_PATH=c:\myapp\symbols;srv*c:\mycache*https://msdl.microsoft.com/download/symbols
```

**重要**   たとえば、UMDH ログを作成する*ログ記録コンピューター*と、umdh ログを分析する*分析コンピューター*の2つのコンピューターがあるとします。 分析コンピューターのシンボルパスは、ログの作成時にログコンピューターに読み込まれた Windows のバージョンのシンボルをポイントする必要があります。 分析コンピューター上のシンボルパスをシンボルサーバーに指定しないでください。 この場合、UMDH は分析コンピューター上で実行されている Windows のバージョンのシンボルを取得します。また、UMDH では意味のある結果が表示されません。


### <a name="disable-bstr-caching"></a>BSTR キャッシュを無効にする

オートメーション (以前の OLE オートメーション) では、BSTR 文字列によって使用されるメモリがキャッシュされます。 これにより、UMDH がメモリ割り当ての所有者を正しく特定できなくなる可能性があります。 この問題を回避するには、BSTR キャッシュを無効にする必要があります。

BSTR キャッシュを無効にするには、OANOCACHE 環境変数を1に等しい値に設定します。 この設定は、割り当てがトレースされるアプリケーションを起動する前に行う必要があります。

または、.NET Framework **SetNoOaCache**関数を呼び出すことによって、アプリケーション自体から BSTR キャッシュを無効にすることもできます。 このメソッドを選択する場合は、 **SetNoOaCache**が呼び出されたときに既にキャッシュされている BSTR 割り当てがキャッシュされたままになるため、この関数を早期に呼び出す必要があります。

サービスによって行われた割り当てをトレースする必要がある場合は、OANOCACHE をシステム環境変数として設定してから、Windows を再起動してこの設定を有効にする必要があります。

### <a name="find-the-process-id"></a>プロセス ID を検索する

UMDH はプロセス識別子 (PID) でプロセスを識別します。 実行中のプロセスの PID は、タスクマネージャー、Tasklist、または[tlist.exe](tlist.md)を使用して見つけることができます。

 

 





