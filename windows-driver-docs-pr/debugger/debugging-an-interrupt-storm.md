---
title: 割り込みストームのデバッグ
description: 割り込みストームのデバッグ
ms.assetid: b863cb9c-dce0-4572-b0ed-6f7d3a6ba472
keywords:
- 保留中の Irp
- I/o 要求パケット (IRP)、保留中
ms.date: 05/15/2020
ms.localizationpriority: medium
ms.openlocfilehash: 131c2ab6bb126e8459a74bf3c77c3e720bcd4987
ms.sourcegitcommit: 4d1ed685d198629f792d287619621a87ca42c26f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/16/2020
ms.locfileid: "83435378"
---
# <a name="debugging-an-interrupt-storm"></a>割り込みストームのデバッグ

## <span id="ddk_debugging_pending_irps_dbg"></span><span id="DDK_DEBUGGING_PENDING_IRPS_DBG"></span>

システムが停止した場合の最も一般的な例の1つは、割り込みストームです。 *割り込みストーム*は、アサート状態のままになるレベルでトリガーされる割り込みシグナルです。

次のイベントによって、割り込みストームが発生する可能性があります。

- ハードウェアデバイスは、デバイスドライバーによって送信された後に、その割り込み信号を解放しません。

- デバイスドライバーは、割り込みシグナルを解放するようにハードウェアに指示しません。これは、割り込み信号がハードウェアから開始されたことを検出しないためです。

- 割り込みがハードウェアから開始されていない場合でも、デバイスドライバーは割り込みを要求します。 この状況は、複数のデバイスが同じ IRQ を共有している場合にのみ発生します。

- エッジレベルのコントロールレジスタ (ELCR) が正しく設定されていません。

- エッジおよびレベルの割り込みによってトリガーされるデバイスは、IRQ (たとえば、COM ポートと PCI SCSI コントローラー) を共有します。

この例では、割り込みストームを検出してデバッグする方法の1つを示します。

コンピューターがハングした場合は、カーネルデバッガーを使用して中断します。 **! Irpfind**拡張コマンドを使用して、保留中の irp を探します。 次に、 **! irp**拡張機能を使用して、保留中の irp の詳細を取得します。 たとえば、次のように入力します。

```dbgcmd
kd> !irp 81183468
Irp is active with 2 stacks 2 is current (= 0x811834fc)
 No Mdl Thread 00000000:  Irp stack trace.
     cmd  flg cl Device   File     Completion-Context
 [  0, 0]   0  0 8145f470 00000000 00000000-00000000
               \Driver\E100B
                        Args: 00000000 00000000 00000000 00000000
>[ 16, 2]   0 e1 8145f470 00000000 8047f744-814187a8 Success Error Cancel pending
               \Driver\E100B    ntoskrnl!PopCompleteSystemPowerIrp
                        Args: 00000000 00000000 00000002 00000002 
```

この例では \\ \\ 、driver e100b からの IRP が返されていないことを示してい**ます。PopCompleteSystemPowerIrp**。 スタックしているように見えますが、割り込みストームが発生している可能性があります。

調査するには、 **kb**コマンドを使用してスタックトレースを要求します。 たとえば、次のように入力します。

```dbgcmd
kd> kb
ChildEBP RetAddr  Args to Child
f714ee68 8046355a 00000001 80068c10 00000030 ntoskrnl!RtlpBreakWithStatusInstruction
f714ee68 80067a4f 00000001 80068c10 00000030 ntoskrnl!KeUpdateSystemTime+0x13e
f714eeec 8046380b 01001010 0000003b f714ef00 halacpi!HalBeginSystemInterrupt+0x83
f714eeec 80463c50 01001010 0000003b f714ef00 ntoskrnl!KiChainedDispatch+0x1b
f714ef78 80067cc2 00000000 00000240 8000017c ntoskrnl!KiDispatchInterrupt
f714ef78 80501cb5 00000000 00000240 8000017c halacpi!HalpDispatchInterrupt2ndEnt  
```

で始まるセクションは割り込みディスパッチであることに注意 `halacpi!HalBeginSystemInterrupt` してください。 **G**コマンドを使用してもう一度中断すると、別のスタックトレースが表示される可能性がありますが、割り込みディスパッチは引き続き表示されます。 どの割り込みがシステムの停止に関与しているかを判断するには、 **HalBeginSystemInterrupt**に渡される2番目のパラメーター (この例では 0x3b) を確認します。 標準の規則では、表示される割り込みベクター (0x3B) は IRQ ラインと0x30 のため、割り込みは数値0xB になります。 別のスタックトレースを実行すると、どのデバイスが割り込みサービス要求 (ISR) を発行したかについての詳細情報が提供される場合があります。 この場合、2番目のスタックトレースの結果は次のようになります。

```dbgcmd
kd> kb
ChildEBP RetAddr  Args to Child
f714ee24 8046355a 00000001 00000010 00000030 ntoskrnl!RtlpBreakWithStatusInstruction
f714ee24 bfe854b9 00000001 00000010 00000030 ntoskrnl!KeUpdateSystemTime+0x13e
f714eed8 f7051796 00000000 80463850 8143ec88 atimpab!AtiInterrupt+0x109
f714eee0 80463850 8143ec88 81444038 8046380b VIDEOPRT!pVideoPortInterrupt+0x16
f714eef8 80463818 00000202 0000003b 80450bb8 ntoskrnl!KiChainedDispatch2ndLvl+0x28
f714eef8 80463c50 00000202 0000003b 80450bb8 ntoskrnl!KiChainedDispatch+0x28
f714ef78 80067cc2 00000000 00000240 8000017c ntoskrnl!KiDispatchInterrupt
f714ef78 80501cb5 00000000 00000240 8000017c halacpi!HalpDispatchInterrupt2ndEntry+0x1b
f714f084 8045f744 f714f16c 00020019 f714f148 ntoskrnl!NtCreateKey+0x113
f714f084 8042e487 f714f16c 00020019 f714f148 ntoskrnl!KiSystemService+0xc4
f714f118 804ab556 f714f16c 00020019 f714f148 ntoskrnl!ZwCreateKey+0xb
f714f184 8041f75b f714f1e8 8000017c f714f1d0 ntoskrnl!IopCreateRegistryKeyEx+0x4e
f714f204 804965cd 8145f630 00000000 00000001 ntoskrnl!IopProcessSetInterfaceState+0x93
f714f220 bfee1eb9 8145f630 00000000 8145f5a0 ntoskrnl!IoSetDeviceInterfaceState+0x2b
f714f254 bfedb416 00000004 00000800 0045f570 NDIS!ndisMCommonHaltMiniport+0x1f
f714f268 bfed4ddb bfed0660 811a2708 811a2708 NDIS!ndisPmHaltMiniport+0x9a
f714f288 bfed5146 811a2708 00000004 8145f570 NDIS!ndisSetPower+0x1d1
f714f2a8 8041c60f 81453a30 811a2708 80475b18 NDIS!ndisPowerDispatch+0x84
f714f2bc 8044cc52 80475b18 811a2708 811a279c ntoskrnl!IopfCallDriver+0x35
f714f2d4 8044cb89 811a279c 811a2708 811a27c0 ntoskrnl!PopPresentIrp+0x62 
```

システムは現在、ビデオカードの ISR を実行しています。 システムは、IRQ 0xB を共有する各デバイスに対して ISR を実行します。 割り込みを要求するプロセスがない場合、オペレーティングシステムは無限に待機し、割り込みを処理するようにドライバー Isr に要求します。 また、プロセスで割り込みが処理されて停止する可能性もありますが、ハードウェアが破損している場合は、割り込みを再アサートするだけで済みます。

**! 監視 4**拡張機能を使用して、IRQ 0xB にあるデバイスを特定します。 IRQ 0xB にデバイスが1つしかない場合は、問題の原因が判明しています。「」を参照してください。 割り込みを共有しているデバイスが複数ある場合 99 (システム状態に対して破壊的)、またはハードウェアを削除または無効にすることによって、デバイスを分離する必要があります。

```dbgcmd
kd> !arbiter 4
DEVNODE 8149a008 (HTREE\ROOT\0)
  Interrupt Arbiter "RootIRQ" at 80472a20
    Allocated ranges:
      0000000000000000 - 0000000000000000   B   8149acd0
      0000000000000001 - 0000000000000001   B   8149acd0
      0000000000000002 - 0000000000000002   B   8149acd0
      0000000000000003 - 0000000000000003   B   8149acd0
      0000000000000004 - 0000000000000004   B   8149acd0
      0000000000000005 - 0000000000000005   B   8149acd0
      0000000000000006 - 0000000000000006   B   8149acd0
      0000000000000007 - 0000000000000007   B   8149acd0
      0000000000000008 - 0000000000000008   B   8149acd0
      0000000000000009 - 0000000000000009   B   8149acd0
      000000000000000a - 000000000000000a   B   8149acd0
      000000000000000b - 000000000000000b   B   8149acd0
      000000000000000c - 000000000000000c   B   8149acd0
 000000000000000d - 000000000000000d   B   8149acd0
      000000000000000e - 000000000000000e   B   8149acd0
 000000000000000f - 000000000000000f   B   8149acd0
      0000000000000010 - 0000000000000010   B   8149acd0
      0000000000000011 - 0000000000000011   B   8149acd0
      0000000000000012 - 0000000000000012   B   8149acd0
      0000000000000013 - 0000000000000013   B   8149acd0
      0000000000000014 - 0000000000000014   B   8149acd0
      0000000000000015 - 0000000000000015   B   8149acd0
      0000000000000016 - 0000000000000016   B   8149acd0
      0000000000000017 - 0000000000000017   B   8149acd0
      0000000000000018 - 0000000000000018   B   8149acd0
      0000000000000019 - 0000000000000019   B   8149acd0
      000000000000001a - 000000000000001a   B   8149acd0
      000000000000001b - 000000000000001b   B   8149acd0
      000000000000001c - 000000000000001c   B   8149acd0
      000000000000001d - 000000000000001d   B   8149acd0
 000000000000001e - 000000000000001e   B   8149acd0
      000000000000001f - 000000000000001f   B   8149acd0
 0000000000000020 - 0000000000000020   B   8149acd0
      0000000000000021 - 0000000000000021   B   8149acd0
      0000000000000022 - 0000000000000022   B   8149acd0
      0000000000000023 - 0000000000000023   B   8149acd0
      0000000000000024 - 0000000000000024   B   8149acd0
      0000000000000025 - 0000000000000025   B   8149acd0
      0000000000000026 - 0000000000000026   B   8149acd0
      0000000000000027 - 0000000000000027   B   8149acd0
      0000000000000028 - 0000000000000028   B   8149acd0
      0000000000000029 - 0000000000000029   B   8149acd0
      000000000000002a - 000000000000002a   B   8149acd0
      000000000000002b - 000000000000002b   B   8149acd0
      000000000000002c - 000000000000002c   B   8149acd0
 000000000000002d - 000000000000002d   B   8149acd0
      000000000000002e - 000000000000002e   B   8149acd0
 000000000000002f - 000000000000002f   B   8149acd0
      0000000000000032 - 0000000000000032   B   8149acd0
      0000000000000039 - 0000000000000039 S     814776d0  (ACPI)
    Possible allocation:
      < none >

    DEVNODE 81476f28 (ACPI_HAL\PNP0C08\0)
      Interrupt Arbiter "ACPI_IRQ" at bfff10e0
        Allocated ranges:
          0000000000000000 - 0000000000000000   B   81495bb0
          0000000000000001 - 0000000000000001       814952b0  (i8042prt)
          0000000000000003 - 0000000000000003 S     81495610  (Serial)
          0000000000000004 - 0000000000000004   B   8149acd0
          0000000000000006 - 0000000000000006       81495730  (fdc)
          0000000000000008 - 0000000000000008       81495a90
          0000000000000009 - 0000000000000009 S     814776d0  (ACPI)
          000000000000000b - 000000000000000b S
            000000000000000b - 000000000000000b S     81453c30  (ds1)
            000000000000000b - 000000000000000b S     81453a30  (E100B)
            000000000000000b - 000000000000000b S     81493c30  (uhcd)
            000000000000000b - 000000000000000b S     8145c390  (atirage3)
          000000000000000c - 000000000000000c       814953d0  (i8042prt)
 000000000000000d - 000000000000000d   B   81495850
          000000000000000e - 000000000000000e       8145bb50  (atapi)
 000000000000000f - 000000000000000f       8145b970  (atapi)
        Possible allocation:
          < none >
```

この場合、オーディオ、Universal Serial Bus (USB)、ネットワークインターフェイスカード (NIC)、ビデオはすべて同じ IRQ を使用します。

どの ISR が割り込みの所有権を要求しているかを調べるには、ISR から戻り値を調べます。 **! 監視**の表示で指定されたアドレスを使用し**て、isr**を直接逆アセンブルし、isr の最後の命令にブレークポイントを設定します (これは ' ret ' 命令になります)。 コマンド**g &lt; アドレス &gt; **を使用することは、そのアドレスにブレークポイントを設定することに相当します。

```dbgcmd
kd> g bfe33e7b
ds1wdm!AdapterIsr+ad:
bfe33e7b c20800           ret     0x8 
```

レジスタを確認するには、 **r**コマンドを使用します。 特に、EAX レジスタを確認します。 次のコード例に示されている EAX レジスタの内容がゼロの場合、この ISR は割り込みを要求しています。 それ以外の場合、割り込みは要求されず、オペレーティングシステムは次の ISR を呼び出します。 この例は、ビデオカードが割り込みを要求していないことを示しています。

```dbgcmd
kd> r
eax=00000000 ebx=813f4ff0 ecx=00000010 edx=ffdff848 esi=8145d168 edi=813f4fc8
eip=bfe33e7b esp=f714eec4 ebp=f714eee0 iopl=0         nv up ei pl zr na po nc
cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00000246
ds1wdm!AdapterIsr+ad:
bfe33e7b c20800           ret     0x8 
```

実際、この場合、IRQ 0xb 上のどのデバイスでも割り込みは要求されません。 この問題が発生した場合は、割り込みに関連付けられているハードウェアの各部分が実際に有効になっているかどうかを確認する必要もあります。 PCI の場合は、次のように、 **! pci**拡張機能の出力によって表示される CMD レジスタを簡単に確認できます。

```dbgcmd
kd> !pci 0 0
PCI Bus 0
00:0  8086:7190.03  Cmd[0006:.mb...]  Sts[2210:c....]  Device  Host bridge
01:0  8086:7191.03  Cmd[0107:imb..s]  Sts[0220:.6...]  PciBridge 0->1-1  PCI-PCI bridge
03:0  1073:000c.03  Cmd[0000:......]  Sts[0210:c....]  Device  SubID:1073:000c Audio device
04:0  8086:1229.05  Cmd[0007:imb...]  Sts[0290:c....]  Device  SubID:8086:0008 Ethernet
07:0  8086:7110.02  Cmd[000f:imb...]  Sts[0280:.....]  Device  ISA bridge
07:1  8086:7111.01  Cmd[0005:i.b...]  Sts[0280:.....]  Device  IDE controller
07:2  8086:7112.01  Cmd[0005:i.b...]  Sts[0280:.....]  Device  USB host controller
07:3  8086:7113.02  Cmd[0003:im....]  Sts[0280:.....]  Device  Class:6:80:0
```

オーディオチップ ("オーディオデバイス") CMD register が0であることに注意してください。 これは、現時点ではオーディオチップが実質的に無効になっていることを意味します。 これは、オーディオチップがドライバーによるアクセスに応答できないことも意味します。

この場合は、オーディオチップを手動で再度有効にする必要があります。
